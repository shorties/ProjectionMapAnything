<!DOCTYPE html>
<html><head>
<meta charset="utf-8">
<meta name="viewport" content="width=360">
<title>PMA Dashboard</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#111318; color:#ccc;
         font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
         font-size:13px; line-height:1.4; min-height:100vh; }
  .dash { max-width:360px; margin:0 auto; padding:10px; display:flex;
          flex-direction:column; gap:8px; }

  /* Header */
  .hdr { display:flex; align-items:center; justify-content:space-between; padding:6px 0; }
  .hdr h1 { font-size:15px; font-weight:700; color:#e94560; letter-spacing:-0.3px; }
  .badge { font-size:10px; padding:2px 6px; border-radius:3px; font-weight:600; }
  .badge-local { background:#1a3a1a; color:#4ecca3; }
  .badge-remote { background:#3a1a1a; color:#e94560; }

  /* Buttons */
  .btn-row { display:flex; gap:6px; }
  .btn { padding:7px 14px; border:none; border-radius:6px; font-size:12px;
         font-weight:600; cursor:pointer; transition:all 0.15s; flex:1; }
  .btn-p { background:#e94560; color:#fff; }
  .btn-p:hover { background:#d13a54; }
  .btn-s { background:#1a2440; color:#aaa; }
  .btn-s:hover { background:#243050; color:#ddd; }
  .btn-sm { padding:5px 10px; font-size:11px; flex:none; }

  /* Sections (collapsible) */
  details { background:#181c24; border-radius:8px; overflow:hidden; }
  details[open] { background:#181c24; }
  summary { padding:10px 12px; font-size:12px; font-weight:600; color:#888;
            text-transform:uppercase; letter-spacing:0.8px; cursor:pointer;
            user-select:none; list-style:none; display:flex;
            align-items:center; justify-content:space-between; }
  summary::-webkit-details-marker { display:none; }
  summary::after { content:'\25B8'; color:#555; font-size:10px; transition:transform 0.15s; }
  details[open] > summary::after { transform:rotate(90deg); }
  summary:hover { color:#bbb; }
  .sec { padding:0 12px 12px; display:flex; flex-direction:column; gap:8px; }

  /* Preview */
  .preview { border-radius:6px; overflow:hidden; background:#000;
             width:100%; aspect-ratio:16/9; position:relative; }
  .preview img { width:100%; height:100%; object-fit:contain; display:block; }
  .preview.stale img { opacity:0.35; transition:opacity 0.5s; }
  .preview .stale-badge { display:none; position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%); background:rgba(0,0,0,0.7); color:#f0c040;
    font-size:11px; padding:3px 8px; border-radius:4px; pointer-events:none; }
  .preview.stale .stale-badge { display:block; }

  /* Form controls */
  .ctrl { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .ctrl-label { font-size:11px; color:#777; white-space:nowrap; min-width:80px; }
  .ctrl select, .ctrl input[type=number], .ctrl input[type=text] {
    flex:1; padding:5px 8px; background:#0d1117; color:#ddd; border:1px solid #2a2f3a;
    border-radius:4px; font-size:12px; outline:none; min-width:0; }
  .ctrl select:focus, .ctrl input:focus { border-color:#4ecca3; }
  .ctrl input[type=range] { flex:1; accent-color:#4ecca3; }
  .range-val { font-size:11px; color:#4ecca3; min-width:36px; text-align:right;
               font-variant-numeric:tabular-nums; }

  /* Toggle switch */
  .toggle { position:relative; width:36px; height:20px; flex-shrink:0; }
  .toggle input { opacity:0; width:0; height:0; }
  .toggle .slider { position:absolute; inset:0; background:#2a2f3a; border-radius:10px;
                    cursor:pointer; transition:background 0.2s; }
  .toggle .slider::before { content:''; position:absolute; width:16px; height:16px;
    left:2px; top:2px; background:#666; border-radius:50%; transition:all 0.2s; }
  .toggle input:checked + .slider { background:#1a4a2a; }
  .toggle input:checked + .slider::before { transform:translateX(16px); background:#4ecca3; }

  /* Progress */
  .prog-wrap { background:#0d1117; border-radius:4px; height:18px;
               overflow:hidden; position:relative; }
  .prog-bar { height:100%; background:linear-gradient(90deg,#4ecca3,#36b88e);
              border-radius:4px; transition:width 0.3s; }
  .prog-text { position:absolute; inset:0; display:flex; align-items:center;
               justify-content:center; font-size:10px; font-weight:600; color:#fff; }

  /* Status dots */
  .dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
  .dot-g { background:#4ecca3; box-shadow:0 0 4px #4ecca3; }
  .dot-y { background:#f0c040; box-shadow:0 0 4px #f0c040; }
  .dot-r { background:#e94560; }

  /* File list */
  .file-row { display:flex; align-items:center; justify-content:space-between;
              background:#0d1117; border-radius:4px; padding:5px 8px; }
  .file-name { font-size:11px; font-family:monospace; color:#aaa; overflow:hidden;
               text-overflow:ellipsis; white-space:nowrap; }

  /* Thumbs */
  .thumb-row { display:flex; gap:6px; flex-wrap:wrap; }
  .thumb { width:100px; height:56px; border-radius:4px; overflow:hidden;
           background:#0d1117; cursor:pointer; border:1px solid transparent; }
  .thumb:hover { border-color:#4ecca3; }
  .thumb img { width:100%; height:100%; object-fit:cover; }

  /* Misc */
  .hidden { display:none !important; }
  .muted { font-size:11px; color:#555; }
  .hint { font-size:11px; color:#666; line-height:1.5; }
  .err { color:#e94560; }
  .ok { color:#4ecca3; }
  a { color:#4ecca3; }
</style>
</head><body>
<div class="dash">

  <!-- Header -->
  <div class="hdr">
    <h1>PMA</h1>
    <span class="badge" id="env-badge"></span>
  </div>

  <!-- Action buttons -->
  <div class="btn-row">
    <button class="btn btn-p" onclick="openProjector()">Projector</button>
    <button class="btn btn-s" onclick="openScope()">Scope</button>
  </div>

  <!-- Preview -->
  <details open>
    <summary>Preview</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Output</span>
        <label class="toggle"><input type="checkbox" checked id="p-preview_enabled" onchange="toggleOutputPreview(this.checked)" /><span class="slider"></span></label>
      </div>
      <div class="preview" id="preview-wrap"><img id="preview" src="/frame" /><span class="stale-badge" id="stale-badge">Stale</span></div>
      <div class="ctrl">
        <span class="ctrl-label">VACE Input</span>
        <label class="toggle"><input type="checkbox" checked id="p-input_preview_enabled" onchange="toggleInputPreview(this.checked)" /><span class="slider"></span></label>
      </div>
      <div class="preview hidden" id="input-preview-wrap">
        <img id="input-preview" />
      </div>
    </div>
  </details>

  <!-- Calibration -->
  <details id="calib-section">
    <summary>Calibration</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Projector W</span>
        <input type="number" id="cal-proj-w" value="1920" min="320" max="7680" style="width:70px;" />
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Projector H</span>
        <input type="number" id="cal-proj-h" value="1080" min="240" max="4320" style="width:70px;" />
      </div>
      <p style="color:#888;font-size:11px;margin:4px 0 6px;">Tip: Use F11 on the projector window — F11 fullscreen persists during calibration.</p>
      <div class="btn-row">
        <button class="btn btn-p" id="cal-start-btn" onclick="startCalibration()">Start Calibration</button>
        <button class="btn btn-s hidden" id="cal-stop-btn" onclick="stopCalibration()">Stop</button>
      </div>
      <div id="cal-progress-wrap" class="hidden">
        <div class="prog-wrap">
          <div class="prog-bar" id="cal-prog-bar" style="width:0%"></div>
          <div class="prog-text" id="cal-prog-text">0%</div>
        </div>
        <div class="ctrl" style="margin-top:4px;">
          <span class="ctrl-label">Phase</span>
          <span class="muted" id="cal-phase">—</span>
        </div>
        <div class="ctrl">
          <span class="ctrl-label">Pattern</span>
          <span class="muted" id="cal-pattern">—</span>
        </div>
        <div class="ctrl">
          <span class="ctrl-label">Coverage</span>
          <span class="muted" id="cal-coverage">—</span>
        </div>
      </div>
      <div id="cal-errors" class="hidden">
        <div class="hint err" id="cal-error-text"></div>
      </div>
      <div id="cal-results" class="hidden">
        <div class="muted" id="cal-result-meta"></div>
        <div class="thumb-row" id="cal-thumbs"></div>
        <div id="cal-files"></div>
        <div class="btn-row" style="margin-top:6px;">
          <button class="btn btn-s btn-sm" onclick="downloadAllCal()">Download All</button>
          <button class="btn btn-s btn-sm" onclick="exportCalibration()">Export .zip</button>
          <label class="btn btn-s btn-sm" style="cursor:pointer;">
            Import .zip
            <input type="file" id="cal-import-file" accept=".zip" style="display:none;" onchange="importCalibration()" />
          </label>
        </div>
        <div class="btn-row" style="margin-top:4px;">
          <button class="btn btn-p btn-sm" id="overlay-coverage-btn" onclick="projectOverlay('coverage_map')">Project Coverage</button>
          <button class="btn btn-s btn-sm" id="overlay-warped-btn" onclick="projectOverlay('warped_camera')">Project Warped</button>
          <button class="btn btn-s btn-sm hidden" id="overlay-off-btn" onclick="projectOverlay('off')">Stop Overlay</button>
        </div>
        <div class="hint" id="cal-transfer-status"></div>
      </div>

      <!-- Intrinsics (collapsed sub-section) -->
      <details style="background:#141820;border-radius:6px;margin-top:6px;">
        <summary style="font-size:11px;padding:8px 10px;">Intrinsics (Camera + Projector)</summary>
        <div class="sec">
          <div class="ctrl">
            <span class="ctrl-label">Square px</span>
            <input type="number" id="intr-square-px" value="0" min="0" max="500" style="width:60px;" />
            <span class="muted" style="font-size:10px;">(0 = auto)</span>
          </div>
          <div class="btn-row">
            <button class="btn btn-p btn-sm" id="intr-start-btn" onclick="startIntrinsics()">Auto Intrinsics</button>
            <button class="btn btn-s btn-sm hidden" id="intr-stop-btn" onclick="stopIntrinsics()">Stop</button>
          </div>
          <div id="intr-progress-wrap" class="hidden">
            <div class="prog-wrap">
              <div class="prog-bar" id="intr-prog-bar" style="width:0%"></div>
              <div class="prog-text" id="intr-prog-text">0%</div>
            </div>
            <div class="ctrl" style="margin-top:4px;">
              <span class="ctrl-label">Position</span>
              <span class="muted" id="intr-position">—</span>
            </div>
            <div class="ctrl">
              <span class="ctrl-label">Detection</span>
              <span class="muted" id="intr-detection">—</span>
            </div>
          </div>
          <div id="intr-results" class="hidden">
            <div class="hint ok" id="intr-result-text"></div>
          </div>
          <div id="intr-errors" class="hidden">
            <div class="hint err" id="intr-error-text"></div>
          </div>
        </div>
      </details>
    </div>
  </details>

  <!-- Depth -->
  <details>
    <summary>Depth</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Mode</span>
        <select onchange="param('depth_mode',this.value)" id="p-depth_mode">
          <option value="ai_depth">AI Depth</option>
          <option value="disparity">Calibration Disparity</option>
          <option value="stereo">Stereo Triangulation</option>
          <option value="canny">Edge Detection</option>
          <option value="warped_rgb">Warped Camera</option>
          <option value="custom">Custom Upload</option>
        </select>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Proj FOV</span>
        <input type="range" min="20" max="120" step="1" value="50"
               oninput="param('projector_fov',+this.value);this.nextElementSibling.textContent=this.value+'°'" id="p-projector_fov" />
        <span class="range-val">50°</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Smoothing</span>
        <input type="range" min="0" max="0.99" step="0.05" value="0.5"
               oninput="param('temporal_smoothing',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-temporal_smoothing" />
        <span class="range-val">0.50</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Blur</span>
        <input type="range" min="0" max="20" step="0.5" value="0"
               oninput="param('depth_blur',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(1)" id="p-depth_blur" />
        <span class="range-val">0.0</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Erosion</span>
        <input type="range" min="0" max="50" step="1" value="0"
               oninput="param('edge_erosion',+this.value);this.nextElementSibling.textContent=this.value" id="p-edge_erosion" />
        <span class="range-val">0</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Contrast</span>
        <input type="range" min="0.5" max="5" step="0.1" value="1"
               oninput="param('depth_contrast',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(1)" id="p-depth_contrast" />
        <span class="range-val">1.0</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Near Clip</span>
        <input type="range" min="0" max="1" step="0.01" value="0"
               oninput="param('depth_near_clip',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-depth_near_clip" />
        <span class="range-val">0.00</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Far Clip</span>
        <input type="range" min="0" max="1" step="0.01" value="1"
               oninput="param('depth_far_clip',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-depth_far_clip" />
        <span class="range-val">1.00</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Edge Blend</span>
        <input type="range" min="0" max="1" step="0.05" value="0"
               oninput="param('edge_blend',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-edge_blend" />
        <span class="range-val">0.00</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Edge Method</span>
        <select onchange="param('edge_method',this.value)" id="p-edge_method">
          <option value="sobel">Sobel</option>
          <option value="canny">Canny</option>
        </select>
      </div>
    </div>
  </details>

  <!-- Effects -->
  <details>
    <summary>Effects</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Effect</span>
        <select onchange="param('active_effect',this.value)" id="p-active_effect">
          <option value="none">None</option>
          <option value="noise_blend">Noise Blend</option>
          <option value="flow_warp">Flow Warp</option>
          <option value="pulse">Pulse</option>
          <option value="wave_warp">Wave Warp</option>
          <option value="kaleido">Kaleido</option>
          <option value="shockwave">Shockwave</option>
          <option value="wobble">Wobble</option>
          <option value="geometry_edges">Geometry Edges</option>
          <option value="depth_fog">Depth Fog</option>
          <option value="radial_zoom">Radial Zoom</option>
        </select>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Intensity</span>
        <input type="range" min="0" max="2" step="0.05" value="0.5"
               oninput="param('effect_intensity',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-effect_intensity" />
        <span class="range-val">0.50</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Speed</span>
        <input type="range" min="0" max="5" step="0.1" value="1"
               oninput="param('effect_speed',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(1)" id="p-effect_speed" />
        <span class="range-val">1.0</span>
      </div>
    </div>
  </details>

  <!-- Subject Isolation -->
  <details>
    <summary>Subject</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Mode</span>
        <select onchange="param('subject_isolation',this.value)" id="p-subject_isolation">
          <option value="none">None</option>
          <option value="depth_band">Depth Band</option>
          <option value="mask">Custom Mask</option>
          <option value="rembg">RemBG (AI)</option>
        </select>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Depth Range</span>
        <input type="range" min="0.05" max="1" step="0.05" value="0.3"
               oninput="param('subject_depth_range',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-subject_depth_range" />
        <span class="range-val">0.30</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Feather</span>
        <input type="range" min="0" max="30" step="1" value="5"
               oninput="param('subject_feather',+this.value);this.nextElementSibling.textContent=this.value" id="p-subject_feather" />
        <span class="range-val">5</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Invert</span>
        <label class="toggle"><input type="checkbox" onchange="param('invert_subject_mask',this.checked)" id="p-invert_subject_mask" /><span class="slider"></span></label>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Edge Feather</span>
        <input type="range" min="0" max="50" step="1" value="0"
               oninput="param('edge_feather',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(0)" id="p-edge_feather" />
        <span class="range-val">0</span>
      </div>
    </div>
  </details>

  <!-- Postprocessor Output -->
  <details>
    <summary>Output (Postprocessor)</summary>
    <div class="sec">
      <div class="hint">Only applies when using the legacy Projector postprocessor.</div>
      <div class="ctrl">
        <span class="ctrl-label">Upscale</span>
        <label class="toggle"><input type="checkbox" checked onchange="param('upscale_to_projector',this.checked)" id="p-upscale_to_projector" /><span class="slider"></span></label>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Subject Mask</span>
        <label class="toggle"><input type="checkbox" onchange="param('apply_subject_mask',this.checked)" id="p-apply_subject_mask" /><span class="slider"></span></label>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Brightness</span>
        <input type="range" min="-0.5" max="0.5" step="0.01" value="0"
               oninput="param('brightness',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-brightness" />
        <span class="range-val">0.00</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Gamma</span>
        <input type="range" min="0.2" max="3" step="0.05" value="1"
               oninput="param('gamma',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-gamma" />
        <span class="range-val">1.00</span>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Contrast</span>
        <input type="range" min="0.5" max="2" step="0.05" value="1"
               oninput="param('contrast',+this.value);this.nextElementSibling.textContent=Number(this.value).toFixed(2)" id="p-contrast" />
        <span class="range-val">1.00</span>
      </div>
    </div>
  </details>

  <!-- Upload -->
  <details>
    <summary>Upload</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Stage</span>
        <select id="upload-stage">
          <option value="depth_warped">Depth (warped)</option>
          <option value="depth_estimated">Depth (needs warp)</option>
          <option value="raw_camera">Raw camera</option>
        </select>
      </div>
      <div class="ctrl">
        <span class="ctrl-label">Type</span>
        <select id="upload-type">
          <option value="depth">Depth Map</option>
          <option value="mask">Isolation Mask</option>
        </select>
      </div>
      <div class="ctrl">
        <input type="file" id="upload-file" accept="image/*" style="flex:1;font-size:11px;color:#aaa;" />
        <button class="btn btn-s btn-sm" onclick="uploadCustom()">Upload</button>
      </div>
      <div class="hint" id="upload-status"></div>
    </div>
  </details>

  <!-- Status -->
  <details>
    <summary>Status</summary>
    <div class="sec">
      <div class="ctrl">
        <span class="ctrl-label">Projector</span>
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="dot" id="proj-dot"></div>
          <span class="muted" id="proj-status">Checking...</span>
        </div>
      </div>
      <div class="muted" id="proj-resolution"></div>
      <div class="ctrl">
        <span class="ctrl-label">Scope</span>
        <input type="text" id="scope-url" placeholder="Scope URL" spellcheck="false" />
      </div>
      <div class="muted">
        <a href="/projector" target="_blank">/projector</a> &middot;
        <a href="/stream" target="_blank">/stream</a> &middot;
        <a href="/frame" target="_blank">/frame</a> &middot;
        <a href="/status" target="_blank">/status</a> &middot;
        <a href="/calibration/status" target="_blank">/cal</a>
      </div>
    </div>
  </details>

</div>

<script>
// -- Helpers --
const host = location.hostname;
const isRunPod = host.includes('.proxy.runpod.net');
const badge = document.getElementById('env-badge');
badge.textContent = isRunPod ? 'RunPod' : 'Local';
badge.className = 'badge ' + (isRunPod ? 'badge-remote' : 'badge-local');

// -- Parameter API --
function param(key, val) {
  const body = {}; body[key] = val;
  fetch('/api/params', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(body)
  }).catch(() => {});
}

// Load current params and sync UI
async function loadParams() {
  try {
    const r = await fetch('/api/params');
    const p = await r.json();
    for (const [k, v] of Object.entries(p)) {
      const el = document.getElementById('p-' + k);
      if (!el) continue;
      if (el.type === 'checkbox') {
        el.checked = !!v;
        el.dispatchEvent(new Event('change'));
      } else if (el.type === 'range') {
        el.value = v;
        const rv = el.nextElementSibling;
        if (rv) rv.textContent = typeof v === 'number' ? (v % 1 === 0 ? v : Number(v).toFixed(2)) : v;
      } else el.value = v;
    }
  } catch {}
}
loadParams();

// -- Scope URL --
const scopeInput = document.getElementById('scope-url');
const savedScope = localStorage.getItem('pma_scope_url');
if (savedScope) scopeInput.value = savedScope;
else if (isRunPod) {
  const m = host.match(/^(.+)-\d+\.proxy\.runpod\.net$/);
  if (m) scopeInput.value = 'https://' + m[1] + '-8000.proxy.runpod.net';
} else scopeInput.value = 'http://localhost:8000';

function openScope() {
  const url = scopeInput.value.trim();
  if (url) { localStorage.setItem('pma_scope_url', url); window.open(url, '_blank'); }
}
let _projectorWin = null;
function openProjector() {
  // Reuse existing window if still open — avoids kicking fullscreen
  if (_projectorWin && !_projectorWin.closed) {
    _projectorWin.focus();
    return;
  }
  _projectorWin = window.open('/projector', 'promap-projector',
    'width=960,height=540,menubar=no,toolbar=no,location=no,status=no');
  if (_projectorWin) _projectorWin.focus();
}

// -- Preview --
let outputPreviewOn = true;
let inputPreviewOn = true;

function toggleOutputPreview(on) {
  outputPreviewOn = on;
  param('preview_enabled', on);
  const wrap = document.getElementById('preview-wrap');
  wrap.classList.toggle('hidden', !on);
  if (!on) document.getElementById('preview').removeAttribute('src');
}

function toggleInputPreview(on) {
  inputPreviewOn = on;
  param('input_preview_enabled', on);
  if (!on) document.getElementById('input-preview-wrap').classList.add('hidden');
}

setInterval(async () => {
  if (!outputPreviewOn) return;
  try {
    const r = await fetch('/frame?t=' + Date.now());
    const age = parseFloat(r.headers.get('X-Frame-Age') || '-1');
    const wrap = document.getElementById('preview-wrap');
    const badge = document.getElementById('stale-badge');
    if (age > 10) {
      wrap.classList.add('stale');
      badge.textContent = 'Stale (' + Math.round(age) + 's)';
    } else {
      wrap.classList.remove('stale');
    }
    if (r.ok) {
      const blob = await r.blob();
      document.getElementById('preview').src = URL.createObjectURL(blob);
    }
  } catch {}
}, 2000);

let inputActive = false;
async function checkInput() {
  if (!inputPreviewOn) return;
  try {
    const r = await fetch('/input-frame', { method: 'HEAD' });
    const wrap = document.getElementById('input-preview-wrap');
    if (r.status === 200) {
      wrap.classList.remove('hidden');
      document.getElementById('input-preview').src = '/input-frame?t=' + Date.now();
      inputActive = true;
    } else if (inputActive) { wrap.classList.add('hidden'); inputActive = false; }
  } catch {}
}
setInterval(checkInput, 3000);

// -- Projector status --
function updateProj() {
  fetch('/config').then(r => r.json()).then(cfg => {
    const dot = document.getElementById('proj-dot');
    const st = document.getElementById('proj-status');
    const res = document.getElementById('proj-resolution');
    if (cfg && cfg.width) {
      dot.className = 'dot dot-g'; st.textContent = 'Connected';
      res.textContent = cfg.width + ' x ' + cfg.height;
    } else { dot.className = 'dot dot-y'; st.textContent = 'Waiting...'; res.textContent = ''; }
  }).catch(() => {
    document.getElementById('proj-dot').className = 'dot dot-r';
    document.getElementById('proj-status').textContent = 'Offline';
  });
}
updateProj(); setInterval(updateProj, 5000);

// -- Calibration --
let calResultFiles = [];
let lastCalibTs = '';
let calPolling = false;

function triggerDl(name) {
  const a = document.createElement('a');
  a.href = '/calibration/download/' + encodeURIComponent(name);
  a.download = name; document.body.appendChild(a); a.click(); a.remove();
}
function downloadAllCal() { let d = 0; calResultFiles.forEach(n => { setTimeout(() => triggerDl(n), d); d += 300; }); }

function startCalibration() {
  param('start_calibration', true);
  document.getElementById('cal-start-btn').classList.add('hidden');
  document.getElementById('cal-stop-btn').classList.remove('hidden');
  document.getElementById('cal-progress-wrap').classList.remove('hidden');
  document.getElementById('cal-results').classList.add('hidden');
  document.getElementById('cal-errors').classList.add('hidden');
  calPolling = true;
  pollCalibrationStatus();
}

function stopCalibration() {
  param('start_calibration', false);
  document.getElementById('cal-start-btn').classList.remove('hidden');
  document.getElementById('cal-stop-btn').classList.add('hidden');
  calPolling = false;
}

function projectOverlay(name) {
  fetch('/api/project-overlay', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({image: name})
  }).then(r => r.json()).then(data => {
    const offBtn = document.getElementById('overlay-off-btn');
    if (name === 'off') {
      offBtn.classList.add('hidden');
    } else if (data.ok) {
      offBtn.classList.remove('hidden');
    }
  }).catch(() => {});
}

function updateCalibUI(data) {
  const isActive = data.active;
  const isComplete = data.complete && data.files && data.files.length > 0;

  // Progress
  if (isActive || (data.progress > 0 && data.progress < 1)) {
    document.getElementById('cal-progress-wrap').classList.remove('hidden');
    const pct = Math.round(data.progress * 100);
    document.getElementById('cal-prog-bar').style.width = pct + '%';
    document.getElementById('cal-prog-text').textContent = pct + '%';
    document.getElementById('cal-phase').textContent = data.phase || '—';
    document.getElementById('cal-pattern').textContent = data.pattern_info || '—';
    if (data.coverage_pct > 0) {
      document.getElementById('cal-coverage').textContent = data.coverage_pct.toFixed(1) + '%';
    }
  }

  // Show/hide start/stop buttons
  if (isActive) {
    document.getElementById('cal-start-btn').classList.add('hidden');
    document.getElementById('cal-stop-btn').classList.remove('hidden');
  } else if (!calPolling) {
    document.getElementById('cal-start-btn').classList.remove('hidden');
    document.getElementById('cal-stop-btn').classList.add('hidden');
  }

  // Errors
  if (data.errors && data.errors.length > 0) {
    document.getElementById('cal-errors').classList.remove('hidden');
    document.getElementById('cal-error-text').textContent = data.errors.join('; ');
  } else {
    document.getElementById('cal-errors').classList.add('hidden');
  }

  // Done — show results
  if (isComplete) {
    if (!isActive) {
      document.getElementById('cal-progress-wrap').classList.add('hidden');
      document.getElementById('cal-start-btn').classList.remove('hidden');
      document.getElementById('cal-stop-btn').classList.add('hidden');
      calPolling = false;
    }
    document.getElementById('cal-results').classList.remove('hidden');
    calResultFiles = data.files;
    const meta = document.getElementById('cal-result-meta');
    let txt = '';
    if (data.timestamp) txt += new Date(data.timestamp).toLocaleString();
    if (data.coverage_pct > 0) txt += ' \u2014 ' + data.coverage_pct.toFixed(1) + '% coverage';
    meta.textContent = txt;

    if (data.timestamp !== lastCalibTs) {
      lastCalibTs = data.timestamp;
      const filesDiv = document.getElementById('cal-files');
      filesDiv.innerHTML = '';
      data.files.forEach(name => {
        const row = document.createElement('div');
        row.className = 'file-row';
        row.innerHTML = '<span class="file-name">' + name + '</span>' +
          '<button class="btn btn-s btn-sm" onclick="triggerDl(\'' +
          name.replace(/'/g, "\\'") + '\')">DL</button>';
        filesDiv.appendChild(row);
      });
      const thumbDiv = document.getElementById('cal-thumbs');
      thumbDiv.innerHTML = '';
      data.files.filter(n => n.endsWith('.png')).forEach(name => {
        const t = document.createElement('div');
        t.className = 'thumb'; t.title = name;
        t.onclick = () => window.open('/calibration/preview/' + encodeURIComponent(name), '_blank');
        t.innerHTML = '<img src="/calibration/preview/' + encodeURIComponent(name) + '?t=' + Date.now() + '" />';
        thumbDiv.appendChild(t);
      });
    }
  } else {
    document.getElementById('cal-results').classList.add('hidden');
  }
}

async function pollCalibrationStatus() {
  try {
    const data = await (await fetch('/calibration/status')).json();
    updateCalibUI(data);
    // Sync projector resolution from config
    if (!calPolling) {
      try {
        const cfg = await (await fetch('/config')).json();
        if (cfg && cfg.width) {
          document.getElementById('cal-proj-w').value = cfg.width;
          document.getElementById('cal-proj-h').value = cfg.height;
        }
      } catch {}
    }
  } catch {}
  setTimeout(pollCalibrationStatus, calPolling ? 1000 : 5000);
}
pollCalibrationStatus();

// -- Intrinsics calibration --
let intrPolling = false;

function startIntrinsics() {
  const pw = parseInt(document.getElementById('cal-proj-w').value) || 1920;
  const ph = parseInt(document.getElementById('cal-proj-h').value) || 1080;
  const sq = parseInt(document.getElementById('intr-square-px').value) || 0;
  const body = { proj_w: pw, proj_h: ph };
  if (sq > 0) body.square_px = sq;
  fetch('/calibrate/intrinsics/start', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  }).then(r => r.json()).then(d => {
    if (d.ok) {
      document.getElementById('intr-start-btn').classList.add('hidden');
      document.getElementById('intr-stop-btn').classList.remove('hidden');
      document.getElementById('intr-progress-wrap').classList.remove('hidden');
      document.getElementById('intr-results').classList.add('hidden');
      document.getElementById('intr-errors').classList.add('hidden');
      if (d.square_px) document.getElementById('intr-square-px').value = d.square_px;
      intrPolling = true;
      pollIntrinsicsStatus();
    } else {
      document.getElementById('intr-errors').classList.remove('hidden');
      document.getElementById('intr-error-text').textContent = d.error || 'Failed to start';
    }
  }).catch(e => {
    document.getElementById('intr-errors').classList.remove('hidden');
    document.getElementById('intr-error-text').textContent = e.message;
  });
}

function stopIntrinsics() {
  fetch('/calibrate/intrinsics/stop', { method: 'POST' }).catch(() => {});
  document.getElementById('intr-start-btn').classList.remove('hidden');
  document.getElementById('intr-stop-btn').classList.add('hidden');
  intrPolling = false;
}

async function pollIntrinsicsStatus() {
  if (!intrPolling) return;
  try {
    const data = await (await fetch('/calibrate/intrinsics/status')).json();
    if (data.active) {
      document.getElementById('intr-progress-wrap').classList.remove('hidden');
      const pct = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
      document.getElementById('intr-prog-bar').style.width = pct + '%';
      document.getElementById('intr-prog-text').textContent = data.current + '/' + data.total;
      document.getElementById('intr-position').textContent =
        'Position ' + (data.current + 1) + '/' + data.total +
        (data.label ? ' (' + data.label + ')' : '');
      document.getElementById('intr-detection').textContent =
        data.detected + ' detected, ' + data.skipped + ' skipped';
    } else if (data.result) {
      intrPolling = false;
      document.getElementById('intr-start-btn').classList.remove('hidden');
      document.getElementById('intr-stop-btn').classList.add('hidden');
      document.getElementById('intr-progress-wrap').classList.add('hidden');
      document.getElementById('intr-results').classList.remove('hidden');
      const r = data.result;
      let txt = 'Camera: fx=' + r.cam_fx.toFixed(1) + ' fy=' + r.cam_fy.toFixed(1) +
                ' (err=' + r.cam_error.toFixed(3) + 'px)';
      if (r.proj_fx) txt += '\nProjector: fx=' + r.proj_fx.toFixed(1) + ' fy=' + r.proj_fy.toFixed(1) +
                ' (err=' + r.proj_error.toFixed(3) + 'px)';
      document.getElementById('intr-result-text').textContent = txt;
      document.getElementById('intr-result-text').style.whiteSpace = 'pre-line';
    } else if (data.error) {
      intrPolling = false;
      document.getElementById('intr-start-btn').classList.remove('hidden');
      document.getElementById('intr-stop-btn').classList.add('hidden');
      document.getElementById('intr-progress-wrap').classList.add('hidden');
      document.getElementById('intr-errors').classList.remove('hidden');
      document.getElementById('intr-error-text').textContent = data.error;
    }
  } catch {}
  if (intrPolling) setTimeout(pollIntrinsicsStatus, 1000);
}

// -- Upload --
async function uploadCustom() {
  const f = document.getElementById('upload-file');
  const st = document.getElementById('upload-status');
  if (!f.files || !f.files[0]) { st.textContent = 'No file selected'; st.className = 'hint err'; return; }
  st.textContent = 'Uploading...'; st.className = 'hint';
  try {
    const stage = document.getElementById('upload-stage').value;
    const type = document.getElementById('upload-type').value;
    const buf = await f.files[0].arrayBuffer();
    const r = await fetch('/upload?stage=' + stage + '&type=' + type, {
      method: 'POST', headers: {'Content-Type': 'application/octet-stream'}, body: buf
    });
    const d = await r.json();
    if (d.ok) { st.textContent = 'Uploaded: ' + d.filename; st.className = 'hint ok'; }
    else { st.textContent = 'Failed: ' + (d.error || ''); st.className = 'hint err'; }
  } catch (e) { st.textContent = 'Error: ' + e.message; st.className = 'hint err'; }
}

// -- Transfer --
function exportCalibration() {
  const st = document.getElementById('cal-transfer-status');
  st.textContent = 'Exporting...'; st.className = 'hint';
  fetch('/calibration/export').then(r => {
    if (!r.ok) throw new Error('No calibration');
    return r.blob();
  }).then(blob => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'pma_calibration.zip';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    st.textContent = 'Exported'; st.className = 'hint ok';
  }).catch(e => { st.textContent = 'Failed: ' + e.message; st.className = 'hint err'; });
}

async function importCalibration() {
  const f = document.getElementById('cal-import-file');
  const st = document.getElementById('cal-transfer-status');
  if (!f.files || !f.files[0]) return;
  st.textContent = 'Importing...'; st.className = 'hint';
  try {
    const buf = await f.files[0].arrayBuffer();
    const r = await fetch('/calibration/import', {
      method: 'POST', headers: {'Content-Type': 'application/zip'}, body: buf
    });
    const d = await r.json();
    if (d.ok) { st.textContent = 'Imported ' + d.files + ' files'; st.className = 'hint ok'; }
    else { st.textContent = 'Failed: ' + (d.error || ''); st.className = 'hint err'; }
  } catch (e) { st.textContent = 'Error: ' + e.message; st.className = 'hint err'; }
  f.value = '';
}
</script>
</body></html>
